version: 2
jobs:
        build:
                working_directory: ~/tmp
                                
                docker:
                    - image: circleci/ruby:2.3-node
                      environment:
                            PGHOST: 127.0.0.1
                            PGUSER: postgres
                            RAILS_ENV: test
                    - image: circleci/postgres:9.6-alpine
                      environment:
                        POSTGRES_USER: postgres
                        POSTGRES_DB: ca_st                            
                        TEST_DATABASE_URL: postgresql://postgres@localhost/ca_st
                steps:
                        - checkout
                        - run: sudo apt-get update
                        - run: sudo apt install postgresql-client-9.6
                        - run: whoami                          
                        - run: ls ~/tmp                                            
                        - run: cat ~/tmp/create_schema.sql
                        - run: |
                            psql \
                            -d $TEST_DATABASE_URL \
                            -c "CREATE SCHEMA IF NOT EXISTS mic_policy_aw;"
                        - run: |
                                psql \
                                -X \
                                -h localhost \
                                -p 5432 \
                                -U postgres \
                                -d ca_st \
                                -a \
                                -f ~/tmp/create_schema.sql \
                                --echo-all
                                
                        - run: |
                                psql \
                                -X \
                                -h localhost \
                                -p 5432 \
                                -U postgres \
                                -d ca_st \
                                -a \
                                -f ~/tmp/create_table.sql \
                                --echo-all
                                
